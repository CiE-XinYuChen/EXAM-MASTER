<!-- templates/favorites.html -->
{% extends 'base.html' %}

{% block title %}我的收藏 - ExamMaster{% endblock %}

{% block content %}
<div class="card">
    <div class="card-title">
        <i class="fas fa-star"></i> 我的收藏
    </div>
    
    {% if favorites %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>题号</th>
                    <th>题干</th>
                    <th>标记</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for f in favorites %}
                <tr>
                    <td>{{ f.question_id }}</td>
                    <td><a href="{{ url_for('show_question', qid=f.question_id) }}">{{ f.stem }}</a></td>
                    <td id="tag_display_{{ f.question_id }}">{{ f.tag }}</td>
                    <td class="d-flex gap-2">
                        <form method="post" action="{{ url_for('unfavorite_question', qid=f.question_id) }}">
                            <button type="submit" class="btn btn-danger btn-sm">取消收藏</button>
                        </form>

                        <form class="update-tag-form d-flex gap-1" data-qid="{{ f.question_id }}" method="post" action="{{ url_for('update_tag', qid=f.question_id) }}">
                            <input type="text" name="tag" placeholder="标记" value="{{ f.tag }}" class="form-control">
                            <button type="submit" class="btn btn-primary btn-sm">更新标记</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 你还没有收藏任何题目。
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.update-tag-form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // 阻止表单默认提交

            const qid = form.getAttribute('data-qid');
            const formData = new FormData(form);

            fetch(form.getAttribute('action'), {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 使用alert-success显示成功消息
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.msg;
                    
                    // 将消息插入表格上方
                    const cardTitle = document.querySelector('.card-title');
                    cardTitle.parentNode.insertBefore(alertDiv, cardTitle.nextSibling);
                    
                    // 5秒后消失
                    setTimeout(() => {
                        alertDiv.style.opacity = '0';
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 500);
                    }, 5000);
                    
                    // 更新显示的标签
                    const tagCell = document.querySelector('#tag_display_' + qid);
                    if (tagCell) {
                        const newTag = formData.get('tag');
                        tagCell.textContent = newTag;
                    }
                } else {
                    // 使用alert-danger显示错误消息
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger';
                    alertDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> 标记更新失败：' + data.msg;
                    
                    // 将消息插入表格上方
                    const cardTitle = document.querySelector('.card-title');
                    cardTitle.parentNode.insertBefore(alertDiv, cardTitle.nextSibling);
                    
                    // 5秒后消失
                    setTimeout(() => {
                        alertDiv.style.opacity = '0';
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 500);
                    }, 5000);
                }
            })
            .catch(err => {
                console.error("更新标记请求失败：", err);
                
                // 使用alert-danger显示错误消息
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> 更新标记请求失败，请稍后重试';
                
                // 将消息插入表格上方
                const cardTitle = document.querySelector('.card-title');
                cardTitle.parentNode.insertBefore(alertDiv, cardTitle.nextSibling);
                
                // 5秒后消失
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 500);
                }, 5000);
            });
        });
    });
});
</script>
{% endblock %}