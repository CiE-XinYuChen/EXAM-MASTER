{% extends "admin/base.html" %}

{% block title %}Agentæµ‹è¯• - ç®¡ç†é¢æ¿{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 200px);
        gap: 20px;
    }

    .chat-sidebar {
        width: 300px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .chat-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f5f7fa;
    }

    .chat-input-area {
        padding: 20px;
        border-top: 1px solid #eee;
        background: white;
    }

    .message {
        margin-bottom: 16px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-user {
        text-align: right;
    }

    .message-content {
        display: inline-block;
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        word-wrap: break-word;
    }

    .message-user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .message-assistant .message-content {
        background: white;
        color: #333;
        border: 1px solid #e0e0e0;
    }

    .tool-call {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        font-size: 0.9em;
    }

    .tool-call-header {
        font-weight: bold;
        color: #856404;
        margin-bottom: 4px;
    }

    .tool-call-details {
        color: #666;
        font-size: 0.85em;
    }

    .config-select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 16px;
        font-size: 14px;
    }

    .agent-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 16px;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #667eea;
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    .chat-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        resize: vertical;
        min-height: 60px;
        font-family: inherit;
    }

    .send-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 10px;
        transition: transform 0.2s;
    }

    .send-button:hover {
        transform: translateY(-2px);
    }

    .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 16px;
        font-size: 0.9em;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .stats {
        margin-top: 8px;
        font-size: 0.85em;
        color: #666;
    }

    .clear-button {
        width: 100%;
        padding: 10px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ¤– Agentæµ‹è¯•</h1>
    <p>æµ‹è¯•AI Agentçš„å·¥å…·è°ƒç”¨èƒ½åŠ›</p>
</div>

<div class="chat-container">
    <!-- ä¾§è¾¹æ  -->
    <div class="chat-sidebar">
        <h3 style="margin-top: 0;">é…ç½®</h3>

        <label style="display: block; margin-bottom: 8px; color: #666;">é€‰æ‹©AIé…ç½®</label>
        <select id="configSelect" class="config-select">
            {% if configs %}
                {% for config in configs %}
                <option value="{{ config.id }}">
                    {{ config.name }} ({{ config.model_name }})
                </option>
                {% endfor %}
            {% else %}
                <option value="">æš‚æ— é…ç½®</option>
            {% endif %}
        </select>

        <div class="agent-toggle">
            <label class="switch">
                <input type="checkbox" id="agentToggle" checked>
                <span class="slider"></span>
            </label>
            <span>å¯ç”¨Agentå·¥å…·</span>
        </div>

        <div class="info-box">
            <strong>ğŸ’¡ æç¤ºï¼š</strong><br>
            å¯ç”¨Agentåï¼ŒAIå¯ä»¥ä¸»åŠ¨è°ƒç”¨å·¥å…·è®¿é—®é¢˜åº“æ•°æ®ã€‚å°è¯•é—®ï¼š"æˆ‘æœ‰å“ªäº›é¢˜åº“ï¼Ÿ"
        </div>

        <div id="statsBox" class="stats" style="display: none;">
            <div><strong>ç»Ÿè®¡ï¼š</strong></div>
            <div>å·¥å…·è°ƒç”¨æ¬¡æ•°: <span id="toolCallCount">0</span></div>
            <div>è¿­ä»£æ¬¡æ•°: <span id="iterationCount">0</span></div>
        </div>

        <button class="clear-button" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
    </div>

    <!-- ä¸»èŠå¤©åŒº -->
    <div class="chat-main">
        <div class="chat-header">
            <h2 style="margin: 0;">Agentå¯¹è¯æµ‹è¯•</h2>
            <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 0.9em;">
                æµ‹è¯•MCPå·¥å…·è°ƒç”¨åŠŸèƒ½
            </p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message message-assistant">
                <div class="message-content">
                    ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œç°åœ¨å…·å¤‡äº†è®¿é—®é¢˜åº“ç³»ç»Ÿçš„èƒ½åŠ›ã€‚<br><br>
                    ä½ å¯ä»¥é—®æˆ‘ï¼š<br>
                    â€¢ "æˆ‘æœ‰å“ªäº›é¢˜åº“ï¼Ÿ"<br>
                    â€¢ "å¸®æˆ‘æŸ¥çœ‹é”™é¢˜"<br>
                    â€¢ "æ˜¾ç¤ºæˆ‘çš„å­¦ä¹ ç»Ÿè®¡"<br>
                    â€¢ æˆ–ä»»ä½•å…¶ä»–é—®é¢˜ï¼
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <textarea id="messageInput" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€)"></textarea>
            <button id="sendButton" class="send-button" onclick="sendMessage()">
                å‘é€æ¶ˆæ¯
            </button>
        </div>
    </div>
</div>

<script>
let isLoading = false;

// ç›‘å¬Enteré”®
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

function addMessage(role, content) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${role}`;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.textContent = content;

    messageDiv.appendChild(contentDiv);
    messagesDiv.appendChild(messageDiv);

    // æ»šåŠ¨åˆ°åº•éƒ¨
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function addToolCalls(toolCalls) {
    if (!toolCalls || toolCalls.length === 0) return;

    const messagesDiv = document.getElementById('chatMessages');

    toolCalls.forEach(call => {
        const toolDiv = document.createElement('div');
        toolDiv.className = 'tool-call';
        toolDiv.innerHTML = `
            <div class="tool-call-header">
                ğŸ”§ å·¥å…·è°ƒç”¨: ${call.tool_name}
            </div>
            <div class="tool-call-details">
                è¿­ä»£ #${call.iteration} |
                çŠ¶æ€: ${call.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}
            </div>
        `;
        messagesDiv.appendChild(toolDiv);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function updateStats(toolCallCount, iterationCount) {
    document.getElementById('toolCallCount').textContent = toolCallCount;
    document.getElementById('iterationCount').textContent = iterationCount;
    document.getElementById('statsBox').style.display = 'block';
}

async function sendMessage() {
    if (isLoading) return;

    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    const configId = document.getElementById('configSelect').value;
    if (!configId) {
        alert('è¯·å…ˆé€‰æ‹©AIé…ç½®');
        return;
    }

    const enableAgent = document.getElementById('agentToggle').checked;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    input.value = '';

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    isLoading = true;
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="loading"></span> æ€è€ƒä¸­...';

    try {
        const response = await fetch('/admin/agent-test/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                config_id: configId,
                message: message,
                enable_agent: enableAgent
            })
        });

        const data = await response.json();

        if (data.success) {
            // æ˜¾ç¤ºå·¥å…·è°ƒç”¨
            if (data.tool_calls && data.tool_calls.length > 0) {
                addToolCalls(data.tool_calls);
                updateStats(data.tool_calls.length, data.total_iterations);
            }

            // æ·»åŠ AIå›å¤
            addMessage('assistant', data.response);
        } else {
            addMessage('assistant', `âŒ é”™è¯¯: ${data.error}`);
        }
    } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        addMessage('assistant', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
    } finally {
        isLoading = false;
        sendButton.disabled = false;
        sendButton.textContent = 'å‘é€æ¶ˆæ¯';
    }
}

function clearChat() {
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.innerHTML = `
        <div class="message message-assistant">
            <div class="message-content">
                ğŸ‘‹ å¯¹è¯å·²æ¸…ç©ºã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
            </div>
        </div>
    `;
    document.getElementById('statsBox').style.display = 'none';
}
</script>
{% endblock %}
