# MCP Integration - AIé¢˜åº“åŠ©æ‰‹

## ğŸ“… å®Œæˆæ—¶é—´: 2025-11-02

---

## ğŸ‰ æ¦‚è¿°

æˆåŠŸå®ç°äº†**Model Context Protocol (MCP)** é›†æˆï¼Œè®©AIæ¨¡å‹èƒ½å¤Ÿé€šè¿‡æ ‡å‡†åŒ–å·¥å…·è®¿é—®EXAM-MASTERé¢˜åº“ç³»ç»Ÿï¼Œå®ç°å¯¹è¯å¼ç­”é¢˜åŠŸèƒ½ã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. MCPå·¥å…·å®šä¹‰ (`app/api/mcp/tools.py`)

å®šä¹‰äº†**12ä¸ªæ ‡å‡†åŒ–MCPå·¥å…·**ï¼Œè¦†ç›–é¢˜åº“ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼š

#### é¢˜åº“ç®¡ç†å·¥å…·
1. **get_question_banks** - è·å–ç”¨æˆ·æœ‰æƒé™è®¿é—®çš„é¢˜åº“åˆ—è¡¨
   - æ”¯æŒåŒ…å«ç»Ÿè®¡ä¿¡æ¯
   - è‡ªåŠ¨æƒé™æ£€æŸ¥

2. **get_questions** - ä»æŒ‡å®šé¢˜åº“è·å–é¢˜ç›®åˆ—è¡¨
   - æ”¯æŒé¢˜å‹ç­›é€‰ï¼ˆå•é€‰/å¤šé€‰/åˆ¤æ–­/å¡«ç©º/é—®ç­”ï¼‰
   - æ”¯æŒéš¾åº¦ç­›é€‰
   - æ”¯æŒ4ç§æ¨¡å¼ï¼šå…¨éƒ¨/åªçœ‹é”™é¢˜/åªçœ‹æ”¶è—/æœªç»ƒä¹ 
   - æ”¯æŒå…³é”®è¯æœç´¢
   - æ”¯æŒæ•°é‡é™åˆ¶

3. **get_question_detail** - è·å–å•ä¸ªé¢˜ç›®è¯¦æƒ…
   - ä¸åŒ…å«ç­”æ¡ˆï¼ˆç”¨äºç­”é¢˜ï¼‰
   - åŒ…å«æ”¶è—çŠ¶æ€ã€é”™é¢˜çŠ¶æ€
   - å¯é€‰åŒ…å«ç­”é¢˜å†å²

4. **search_questions** - è·¨é¢˜åº“æœç´¢é¢˜ç›®
   - æ”¯æŒå¤šèŒƒå›´æœç´¢ï¼ˆé¢˜å¹²/é€‰é¡¹/è§£æ/æ ‡ç­¾ï¼‰
   - æ”¯æŒé™å®šé¢˜åº“èŒƒå›´
   - è‡ªåŠ¨æƒé™æ£€æŸ¥

#### ç­”é¢˜ç»ƒä¹ å·¥å…·
5. **create_practice_session** - åˆ›å»ºç­”é¢˜ä¼šè¯
   - æ”¯æŒ4ç§æ¨¡å¼ï¼ˆé¡ºåº/éšæœº/é”™é¢˜/æ”¶è—ï¼‰
   - æ”¯æŒé¢˜å‹å’Œéš¾åº¦ç­›é€‰
   - è‡ªåŠ¨ç”Ÿæˆé¢˜ç›®åˆ—è¡¨

6. **submit_answer** - æäº¤ç”¨æˆ·ç­”æ¡ˆ
   - è‡ªåŠ¨åˆ¤åˆ†ï¼ˆå•é€‰/å¤šé€‰/åˆ¤æ–­ï¼‰
   - è¿”å›æ­£ç¡®ç­”æ¡ˆå’Œè§£æ
   - è‡ªåŠ¨æ›´æ–°é”™é¢˜æœ¬
   - è®°å½•ç­”é¢˜æ—¶é•¿

7. **get_question_explanation** - è·å–é¢˜ç›®è§£æ
   - åŒ…å«æ­£ç¡®ç­”æ¡ˆ
   - åŒ…å«è¯¦ç»†è§£æ
   - å¯é€‰åŒ…å«ç›¸å…³é¢˜ç›®

#### é”™é¢˜ç®¡ç†å·¥å…·
8. **get_wrong_questions** - è·å–é”™é¢˜åˆ—è¡¨
   - æ”¯æŒé¢˜åº“ç­›é€‰
   - æ”¯æŒå·²è®¢æ­£/æœªè®¢æ­£ç­›é€‰
   - æ”¯æŒæŒ‰é”™è¯¯æ¬¡æ•°ç­›é€‰
   - æŒ‰é”™è¯¯æ¬¡æ•°å€’åºæ’åˆ—

9. **mark_wrong_question_corrected** - æ ‡è®°é”™é¢˜å·²è®¢æ­£

#### æ”¶è—ç®¡ç†å·¥å…·
10. **add_favorite** - æ·»åŠ æ”¶è—
    - æ”¯æŒæ·»åŠ å¤‡æ³¨

11. **get_favorites** - è·å–æ”¶è—åˆ—è¡¨
    - æ”¯æŒé¢˜åº“ç­›é€‰
    - æŒ‰æ”¶è—æ—¶é—´å€’åº

#### ç»Ÿè®¡æŸ¥è¯¢å·¥å…·
12. **get_user_statistics** - è·å–ç”¨æˆ·ç»Ÿè®¡
    - æ”¯æŒå•é¢˜åº“ç»Ÿè®¡
    - æ”¯æŒæ€»ä½“ç»Ÿè®¡
    - åŒ…å«8é¡¹æ ¸å¿ƒæŒ‡æ ‡

---

### 2. å·¥å…·å¤„ç†å™¨ (`app/api/mcp/handlers.py`)

ä¸ºæ¯ä¸ªå·¥å…·å®ç°äº†å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ï¼š

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æƒé™æ£€æŸ¥ - è‡ªåŠ¨éªŒè¯ç”¨æˆ·é¢˜åº“è®¿é—®æƒé™
- âœ… æ•°æ®æ ¼å¼åŒ– - ç»Ÿä¸€çš„é¢˜ç›®æ•°æ®æ ¼å¼
- âœ… è‡ªåŠ¨åˆ¤åˆ† - æ”¯æŒå•é€‰/å¤šé€‰/åˆ¤æ–­é¢˜
- âœ… é”™é¢˜ç®¡ç† - ç­”é”™è‡ªåŠ¨åŠ å…¥é”™é¢˜æœ¬ï¼Œç­”å¯¹è‡ªåŠ¨æ ‡è®°è®¢æ­£
- âœ… ä¼šè¯è·Ÿè¸ª - è‡ªåŠ¨æ›´æ–°ç­”é¢˜ä¼šè¯ç»Ÿè®¡
- âœ… å¿«ç…§ä¿å­˜ - é¢˜ç›®å¿«ç…§é˜²æ­¢æ•°æ®å˜åŒ–

**12ä¸ªå¤„ç†å‡½æ•°**:
- `handle_get_question_banks()`
- `handle_get_questions()`
- `handle_get_question_detail()`
- `handle_submit_answer()`
- `handle_get_wrong_questions()`
- `handle_search_questions()`
- `handle_get_user_statistics()`
- `handle_add_favorite()`
- `handle_get_favorites()`
- `handle_create_practice_session()`
- `handle_get_question_explanation()`
- `handle_mark_wrong_question_corrected()`

---

### 3. MCP APIç«¯ç‚¹ (`app/api/mcp/router.py`)

æä¾›æ ‡å‡†åŒ–çš„REST APIæ¥å£ï¼š

#### æ ¸å¿ƒç«¯ç‚¹

**å·¥å…·å‘ç°**:
```
GET /api/v1/mcp/tools
GET /api/v1/mcp/tools/{tool_name}
GET /api/v1/mcp/categories
```
- æ”¯æŒOpenAI Function Callingæ ¼å¼
- æ”¯æŒClaude Toolsæ ¼å¼
- å·¥å…·åˆ†ç±»å±•ç¤º

**å·¥å…·æ‰§è¡Œ**:
```
POST /api/v1/mcp/execute
POST /api/v1/mcp/batch
```
- å•ä¸ªå·¥å…·æ‰§è¡Œ
- æ‰¹é‡å·¥å…·æ‰§è¡Œï¼ˆæé«˜æ•ˆç‡ï¼‰
- è‡ªåŠ¨æ³¨å…¥user_id
- ç»Ÿä¸€é”™è¯¯å¤„ç†

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… JWTè®¤è¯ä¿æŠ¤
- âœ… è‡ªåŠ¨ç”¨æˆ·æ³¨å…¥
- âœ… å·¥å…·æ ¼å¼è½¬æ¢ï¼ˆOpenAI/Claudeï¼‰
- âœ… æ‰¹é‡æ‰§è¡Œä¼˜åŒ–
- âœ… è¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… å·¥å…·åˆ†ç±»ç®¡ç†

---

### 4. AIæœåŠ¡æŠ½è±¡å±‚ (`app/services/ai/base.py`)

å®šä¹‰äº†ç»Ÿä¸€çš„AIæœåŠ¡æ¥å£ï¼š

**æ ¸å¿ƒç±»**:
- `MessageRole` - æ¶ˆæ¯è§’è‰²æšä¸¾
- `Message` - å¯¹è¯æ¶ˆæ¯æ¨¡å‹
- `AIModelConfig` - AIæ¨¡å‹é…ç½®
- `AIResponse` - AIå“åº”æ¨¡å‹
- `BaseAIService` - AIæœåŠ¡åŸºç±»

**æŠ½è±¡æ¥å£**:
```python
class BaseAIService(ABC):
    async def chat(messages, tools, stream=False) -> AIResponse
    async def chat_stream(messages, tools) -> AsyncIterator[str]
    def format_tools(tools) -> List[Dict]
    def parse_tool_call(tool_call) -> Dict
```

ä¸ºåç»­å®ç°å¤šæ¨¡å‹æ”¯æŒæä¾›äº†ç»Ÿä¸€æ¥å£ã€‚

---

## ğŸ“Š æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AI Models                           â”‚
â”‚   (OpenAI / Claude / æ™ºè°±AI / Custom)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MCP API Layer (FastAPI)                       â”‚
â”‚  - GET /mcp/tools         (å·¥å…·å‘ç°)                     â”‚
â”‚  - POST /mcp/execute      (å·¥å…·æ‰§è¡Œ)                     â”‚
â”‚  - POST /mcp/batch        (æ‰¹é‡æ‰§è¡Œ)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Tool Handlers Layer                         â”‚
â”‚  - æƒé™æ£€æŸ¥                                               â”‚
â”‚  - æ•°æ®æŸ¥è¯¢                                               â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘                                               â”‚
â”‚  - ç»“æœæ ¼å¼åŒ–                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Database Layer                             â”‚
â”‚  - Question Bank DB (é¢˜åº“ã€é¢˜ç›®ã€èµ„æº)                    â”‚
â”‚  - Practice DB (ç­”é¢˜è®°å½•ã€ä¼šè¯ã€é”™é¢˜ã€æ”¶è—)               â”‚
â”‚  - Statistics DB (ç»Ÿè®¡æ•°æ®)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. AIå¯¹è¯å¼ç­”é¢˜

```python
# AIè°ƒç”¨å·¥å…·è·å–é¢˜ç›®
response = await execute_tool("get_questions", {
    "user_id": 1,
    "bank_id": "bank123",
    "limit": 1
})

# AIå±•ç¤ºé¢˜ç›®ç»™ç”¨æˆ·
# ç”¨æˆ·å›ç­”

# AIè°ƒç”¨å·¥å…·æäº¤ç­”æ¡ˆ
result = await execute_tool("submit_answer", {
    "user_id": 1,
    "question_id": "q123",
    "user_answer": {"answer": "A"},
    "time_spent": 30
})

# AIæ ¹æ®ç»“æœç»™å‡ºåé¦ˆå’Œè§£æ
```

### 2. æ™ºèƒ½é”™é¢˜è®¢æ­£

```python
# AIè·å–é”™é¢˜åˆ—è¡¨
wrong_q = await execute_tool("get_wrong_questions", {
    "user_id": 1,
    "min_error_count": 2  # é«˜é¢‘é”™é¢˜
})

# AIå¸®åŠ©ç”¨æˆ·é€ä¸ªæ”»å…‹é”™é¢˜
# ç­”å¯¹åè‡ªåŠ¨æ ‡è®°è®¢æ­£
```

### 3. ä¸ªæ€§åŒ–å­¦ä¹ å»ºè®®

```python
# AIè·å–ç”¨æˆ·ç»Ÿè®¡
stats = await execute_tool("get_user_statistics", {
    "user_id": 1
})

# æ ¹æ®æ­£ç¡®ç‡ã€é”™é¢˜åˆ†å¸ƒç­‰ç»™å‡ºå­¦ä¹ å»ºè®®
```

---

## ğŸ”§ å·¥å…·æ ¼å¼æ”¯æŒ

### OpenAI Function Callingæ ¼å¼

```json
{
  "type": "function",
  "function": {
    "name": "get_questions",
    "description": "ä»æŒ‡å®šé¢˜åº“è·å–é¢˜ç›®åˆ—è¡¨",
    "parameters": {
      "type": "object",
      "properties": {
        "bank_id": {
          "type": "string",
          "description": "é¢˜åº“ID"
        },
        "limit": {
          "type": "number",
          "description": "è¿”å›é¢˜ç›®æ•°é‡é™åˆ¶"
        }
      },
      "required": ["bank_id"]
    }
  }
}
```

### Claude Toolsæ ¼å¼

```json
{
  "name": "get_questions",
  "description": "ä»æŒ‡å®šé¢˜åº“è·å–é¢˜ç›®åˆ—è¡¨",
  "input_schema": {
    "type": "object",
    "properties": {
      "bank_id": {
        "type": "string",
        "description": "é¢˜åº“ID"
      },
      "limit": {
        "type": "number",
        "description": "è¿”å›é¢˜ç›®æ•°é‡é™åˆ¶"
      }
    },
    "required": ["bank_id"]
  }
}
```

---

## ğŸ“ APIä½¿ç”¨ç¤ºä¾‹

### 1. è·å–å¯ç”¨å·¥å…·åˆ—è¡¨

```bash
curl -X GET "http://127.0.0.1:8000/api/v1/mcp/tools?format=openai" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 2. æ‰§è¡Œå•ä¸ªå·¥å…·

```bash
curl -X POST "http://127.0.0.1:8000/api/v1/mcp/execute" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "get_questions",
    "parameters": {
      "bank_id": "bank123",
      "limit": 5
    }
  }'
```

### 3. æ‰¹é‡æ‰§è¡Œå·¥å…·

```bash
curl -X POST "http://127.0.0.1:8000/api/v1/mcp/batch" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "calls": [
      {
        "tool_name": "get_question_banks",
        "parameters": {"include_stats": true}
      },
      {
        "tool_name": "get_user_statistics",
        "parameters": {}
      }
    ]
  }'
```

---

## ğŸš€ åç»­å¾…å®Œæˆ

### 1. AIæœåŠ¡å®ç°
- [ ] OpenAIæœåŠ¡å®ç° (`app/services/ai/openai_service.py`)
- [ ] ClaudeæœåŠ¡å®ç° (`app/services/ai/claude_service.py`)
- [ ] æ™ºè°±AIæœåŠ¡å®ç° (`app/services/ai/zhipu_service.py`)
- [ ] è‡ªå®šä¹‰APIæœåŠ¡å®ç° (`app/services/ai/custom_service.py`)

### 2. å¯¹è¯å¼ç­”é¢˜API
- [ ] åˆ›å»ºAIå¯¹è¯ä¼šè¯
- [ ] æµå¼å¯¹è¯æ¥å£
- [ ] å¯¹è¯å†å²ç®¡ç†
- [ ] å·¥å…·è°ƒç”¨è‡ªåŠ¨åŒ–

### 3. AIé…ç½®ç®¡ç†
- [ ] AIæ¨¡å‹é…ç½®ç•Œé¢
- [ ] APIå¯†é’¥ç®¡ç†
- [ ] æ¨¡å‹åˆ‡æ¢åŠŸèƒ½
- [ ] ä½¿ç”¨é‡ç»Ÿè®¡

---

## ğŸ“ ä¼˜åŠ¿ç‰¹æ€§

### 1. æ ‡å‡†åŒ–æ¥å£
- åŸºäºMCPåè®®
- æ”¯æŒä¸»æµAIå¹³å°ï¼ˆOpenAIã€Claudeï¼‰
- æ˜“äºæ‰©å±•æ–°çš„AIæ¨¡å‹

### 2. å®‰å…¨å¯é 
- JWTè®¤è¯ä¿æŠ¤
- è‡ªåŠ¨æƒé™æ£€æŸ¥
- æ•°æ®éš”ç¦»
- é”™è¯¯å¤„ç†å®Œå–„

### 3. é«˜æ€§èƒ½
- æ‰¹é‡å·¥å…·æ‰§è¡Œ
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- å¼‚æ­¥å¤„ç†

### 4. æ˜“äºä½¿ç”¨
- RESTful API
- æ¸…æ™°çš„æ–‡æ¡£
- ç»Ÿä¸€çš„å“åº”æ ¼å¼
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- MCPå·¥å…·å®šä¹‰: `app/api/mcp/tools.py`
- å·¥å…·å¤„ç†å™¨: `app/api/mcp/handlers.py`
- APIè·¯ç”±: `app/api/mcp/router.py`
- AIæœåŠ¡åŸºç±»: `app/services/ai/base.py`
- APIæ–‡æ¡£: `http://127.0.0.1:8000/docs` (æŸ¥çœ‹MCPæ ‡ç­¾)

---

## âœ¨ æ€»ç»“

MCPé›†æˆå·²å®Œæˆæ ¸å¿ƒæ¶æ„ï¼ŒåŒ…æ‹¬ï¼š
- âœ… 12ä¸ªæ ‡å‡†åŒ–å·¥å…·
- âœ… å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘
- âœ… RESTful APIæ¥å£
- âœ… AIæœåŠ¡æŠ½è±¡å±‚
- âœ… å¤šæ ¼å¼æ”¯æŒï¼ˆOpenAI/Claudeï¼‰
- âœ… æ‰¹é‡æ‰§è¡Œä¼˜åŒ–

ä¸ºAIé©±åŠ¨çš„æ™ºèƒ½ç­”é¢˜ç³»ç»Ÿå¥ å®šäº†åšå®åŸºç¡€ï¼
